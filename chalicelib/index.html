<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/css/bootstrap.min.css" integrity="sha512-SbiR/eusphKoMVVXysTKG/7VseWii+Y3FdHrt0EpKgpToZeemhqHeZeLWLhJutz/2ut2Vw1uQEj2MbRF+TVBUA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <title>Entity Resolution</title>
</head>
<body>
    <div class="container">
        <div id="output"></div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.3.4/axios.min.js" integrity="sha512-LUKzDoJKOLqnxGWWIBM4lzRBlxcva2ZTztO8bTcWPmDSpkErWx0bSP4pdsjNH8kiHAUPaT06UXcb+vOEZH+HpQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.7.7/handlebars.min.js" integrity="sha512-RNLkV3d+aLtfcpEyFG8jRbnWHxUqVZozacROI4J2F1sTaDqo1dPQYs01OMi1t1w9Y2FdbSCDSQ2ZVdAC8bzgAg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        async function saveSelection(random, selection) {
            var timestamp = Date.now();
            var payload = {
                "key": "customers/" + timestamp + ".json",
                "data": {
                    "timestamp": timestamp,
                    "user_entered": random,
                    "selected": selection.fullname
                }
            };
            console.log('payload', payload);
            var response = await axios.put('/put', payload);
            console.log('put response', response);
        }


        function onSelected(selected_index) {
            var random = window.random_and_similar.data.random;
            var selection = window.random_and_similar.data.similar[selected_index];
            console.log('random', random, 'selection', selection);
            saveSelection(random, selection);
            showChoices();
        }


        async function showChoices() {
            var random_and_similar = await axios.get('/get_random_and_similar');
            console.log('random_and_similar', random_and_similar);
            var template = Handlebars.compile(`User entered: <div><h1>{{random}}</h1></div><br>
            {{#each similar}}
            <div class="row m-4">
              <button type="button" class="btn btn-primary btn-lg btn-block" onclick="onSelected({{@index}})">
                {{fullname}} ({{ratio}}%)
              </button>
            </div>
            {{/each}}`);
            window.random_and_similar = random_and_similar;
            document.getElementById('output').innerHTML = template(random_and_similar.data);

        }

        async function main() {
            await showChoices();
        }
        main();
    </script>
</body>
</html>